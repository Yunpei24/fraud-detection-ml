name: Deploy API to Azure Web App

on:
  # Déploiement automatique sur push vers main
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'common/**'
      - '.github/workflows/deploy-azure.yml'
  
  # Déploiement automatique après merge d'une PR vers main
  pull_request:
    branches:
      - main
    types: [closed]
    paths:
      - 'api/**'
      - 'common/**'
  
  # Déploiement manuel (optionnel)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_WEBAPP_NAME: fraud-detection-api
  DOCKER_IMAGE: jyen24/api
  PYTHON_VERSION: '3.10'

jobs:
  # Job 1: Build et push de l'image Docker
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    # Exécute seulement si PR merged ou push direct sur main
    if: |
      github.event_name == 'push' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:main-${{ github.run_number }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      - name: Image digest
        run: |
          echo "Image pushed: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}"
          echo "Image size: $(docker images ${{ env.DOCKER_IMAGE }}:${{ github.sha }} --format '{{.Size}}')"

  # Job 2: Deploy vers Azure Web App
  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
      - name: Checkout code (for health check script)
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set Web App Container Settings
        run: |
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --docker-custom-image-name ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            --docker-registry-server-url https://index.docker.io
      
      - name: Configure Web App Settings
        run: |
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              ENVIRONMENT=production \
              WEBSITES_PORT=8000 \
              DOCKER_REGISTRY_SERVER_URL=https://index.docker.io \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
              DEPLOYMENT_SHA=${{ github.sha }} \
              DEPLOYMENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      
      - name: Restart Web App
        run: |
          echo " Restarting Azure Web App..."
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
      
      - name: Wait for deployment
        run: |
          echo " Waiting 60 seconds for container to start..."
          sleep 60
      
      - name: Health Check
        run: |
          echo " Checking API health..."
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health \
              || echo "000")
            
            if [ "$response" = "200" ]; then
              echo " Health check passed!"
              curl -s https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health | jq '.'
              exit 0
            fi
            
            echo " Health check failed (HTTP $response). Retrying in 10s..."
            sleep 10
          done
          
          echo " Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Get deployment logs (on failure)
        if: failure()
        run: |
          echo " Fetching container logs..."
          az webapp log tail \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --lines 100
      
      - name: Azure logout
        if: always()
        run: az logout

  # Job 3: Post-deployment tests (optionnel)
  test:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install test dependencies
        run: |
          pip install requests pytest
      
      - name: Test API endpoints
        run: |
          echo " Testing API endpoints..."
          
          # Test 1: Health endpoint
          echo "Test 1: Health check"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health || exit 1
          
          # Test 2: Docs endpoint
          echo "Test 2: API docs"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/docs || exit 1
          
          # Test 3: Metrics endpoint
          echo "Test 3: Metrics"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/metrics || exit 1
          
          echo " All endpoint tests passed!"
      
      - name: Notify deployment success
        run: |
          echo " Deployment successful!"
          echo "API URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "Docs: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/docs"
          echo "SHA: ${{ github.sha }}"
