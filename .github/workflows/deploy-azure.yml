name: Deploy API to Azure Web App

on:
  # Automatic deployment after CI/CD workflow completes successfully on main
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main
  
  # Manual deployment (optional)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/api
  STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
  PYTHON_VERSION: '3.10'

jobs:
  # Deploy to Azure Web App using the image built by ci-cd.yml
  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    # Only execute if:
    # 1. Manual trigger (workflow_dispatch)
    # 2. CI/CD workflow completed successfully on main branch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.head_branch == 'main')
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Check if Web App exists
        id: check_webapp
        run: |
          if az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Resource Group Location
        id: get_location
        run: |
          LOCATION=$(az group show --name ${{ secrets.AZURE_RESOURCE_GROUP }} --query location -o tsv)
          echo "location=$LOCATION" >> $GITHUB_OUTPUT
          echo " Resource Group location: $LOCATION"
      
      - name: Create App Service plan (if needed)
        if: steps.check_webapp.outputs.exists == 'false'
        run: |
          echo " Creating App Service Plan..."
          az appservice plan create \
            --name fraud-detection-plan \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --is-linux \
            --sku B1 \
            --location ${{ steps.get_location.outputs.location }}
      
      - name: Create Web App (if needed)
        if: steps.check_webapp.outputs.exists == 'false'
        run: |
          echo " Creating Web App..."
          az webapp create \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --plan fraud-detection-plan \
            --deployment-container-image-name ${{ env.DOCKER_IMAGE }}:latest
      
      - name: Set Web App Container Settings
        run: |
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --container-image-name ${{ env.DOCKER_IMAGE }}:latest \
            --container-registry-url https://index.docker.io
      
      - name: Check if Storage Account exists
        id: check_storage
        run: |
          if az storage account show \
            --name ${{ env.STORAGE_ACCOUNT_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo " Storage Account exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo " Storage Account does not exist"
          fi

      - name: Create Storage Account (if needed)
        if: steps.check_storage.outputs.exists == 'false'
        run: |
          echo " Creating Storage Account..."
          
          # Get location from Web App
          LOCATION=$(az webapp show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query location -o tsv)
          
          az storage account create \
            --name ${{ env.STORAGE_ACCOUNT_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --location ${{ secrets.AZURE_LOCATION }} \
            --sku Standard_LRS \
            --kind StorageV2 \
            --allow-blob-public-access false
          
          echo " Storage Account created"

      - name: Get Storage Account Key
        id: get_storage_key
        run: |
          STORAGE_KEY=$(az storage account keys list \
            --account-name ${{ env.STORAGE_ACCOUNT_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "[0].value" -o tsv)
          
          # Masquer la clé dans les logs GitHub
          echo "::add-mask::$STORAGE_KEY"
          echo "key=$STORAGE_KEY" >> $GITHUB_OUTPUT
          echo " Storage key retrieved"

      - name: Create File Share (if needed)
        run: |
          echo " Checking File Share..."
          
          SHARE_EXISTS=$(az storage share exists \
            --name fraud-models \
            --account-name ${{ env.STORAGE_ACCOUNT_NAME }} \
            --account-key "${{ steps.get_storage_key.outputs.key }}" \
            --query "exists" -o tsv)
          
          if [ "$SHARE_EXISTS" != "true" ]; then
            echo "Creating File Share..."
            az storage share create \
              --name fraud-models \
              --account-name ${{ env.STORAGE_ACCOUNT_NAME }} \
              --account-key "${{ steps.get_storage_key.outputs.key }}" \
              --quota 20
            echo " File Share created (20 GB quota)"
          else
            echo " File Share already exists"
          fi

      - name: Mount File Share to Web App
        run: |
          echo " Mounting File Share to Web App..."
          
          # Supprimer le montage existant (si présent) pour éviter les conflits
          az webapp config storage-account delete \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --custom-id FraudModelsStorage 2>/dev/null || true
          
          # Créer le nouveau montage
          az webapp config storage-account add \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --custom-id FraudModelsStorage \
            --storage-type AzureFiles \
            --share-name fraud-models \
            --account-name ${{ env.STORAGE_ACCOUNT_NAME }} \
            --access-key "${{ steps.get_storage_key.outputs.key }}" \
            --mount-path /mnt/fraud-models
          
          echo " File Share mounted at /mnt/fraud-models"

      - name: Verify File Share Mount
        run: |
          echo " Verifying File Share configuration..."
          
          az webapp config storage-account list \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "[?name=='FraudModelsStorage'].{MountPath:mountPath, ShareName:shareName}" \
            --output table
      
      - name: Configure Web App Settings
        run: |
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              ENVIRONMENT=production \
              WEBSITES_PORT=8000 \
              MODEL_STORAGE_PATH=/mnt/fraud-models \
              DOCKER_REGISTRY_SERVER_URL=https://index.docker.io \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
              DEPLOYMENT_SHA=${{ github.sha }} \
              MLFLOW_TRACKING_URI="http://40.66.54.22:5000" \
              DEPLOYMENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      
      - name: Restart Web App
        run: |
          echo " Restarting Azure Web App..."
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
      
      - name: Wait for deployment
        run: |
          echo " Waiting 60 seconds for container to start..."
          sleep 60
      
      - name: Health Check
        run: |
          echo " Checking API health..."
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health \
              || echo "000")
            
            if [ "$response" = "200" ]; then
              echo " Health check passed!"
              curl -s https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health | jq '.'
              exit 0
            fi
            
            echo " Health check failed (HTTP $response). Retrying in 10s..."
            sleep 10
          done

          echo " Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Get deployment logs (on failure)
        if: failure()
        run: |
          echo " Fetching container logs..."
          az webapp log download \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --log-file deployment-logs.zip || true
          
          # Alternative: stream logs
          timeout 30s az webapp log tail \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} || true
      
      - name: Azure logout
        if: always()
        run: az logout

  # Post-deployment tests
  test:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install test dependencies
        run: |
          pip install requests pytest
      
      - name: Test API endpoints
        run: |
          echo " Testing API endpoints..."
          
          # Test 1: Health endpoint
          echo "Test 1: Health check"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health || exit 1
          
          # Test 2: Metrics endpoint
          echo "Test 2: Metrics"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/metrics || exit 1
          
          echo " All endpoint tests passed!"
      
      - name: Notify deployment success
        run: |
          echo " Deployment successful!"
          echo "API URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "SHA: ${{ github.sha }}"
